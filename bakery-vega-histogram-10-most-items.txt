{


  $schema: https://vega.github.io/schema/vega-lite/v2.json
  title: Event counts from all indexes

  // Define the data source
  data: {
    url: {


      // Apply dashboard context filters when set
      %context%: true
      // Filter the time picker (upper right corner) with this field


      // Which index to search
      index: _all
      // Aggregate data by the time field into time buckets, counting the number of documents in each bucket.
      body: {
        "aggs": {
          "range_buckets": {
            "terms": {
              "field": "item.keyword",
              "size": 10,
              "order": {
                "_count": "desc"
              }
            }
          }
        }
        
        // Speed up the response by only including aggregation results
        size: 0
      }
    }

    format: {property: "aggregations.range_buckets.buckets"}
  }

  "transform": [{
    "window": [{
      "op": "sum",
      "field": "doc_count",
      "as": "totalSales"
    }],
    "frame": [null, null]
  },
    {
      "calculate": "datum.doc_count/datum.totalSales * 100",
      "as": "percentOfTotal"
    }],
  "mark": "bar",
  "encoding": {
    "y": {
      "field": "percentOfTotal",
      "type": "quantitative",
      "axis": {
        "title": "% ventes totales"
      }
    },
    "x": {
      "field": "key",
      "type": "nominal",
      "axis": {
        "title": "Produit - item"
      }   
     sort: {
        op : mean
        field: percentOfTotal
        order : descending
      }         
    }
    color : {
      field : key
      type  : nominal
    }    
  }

}
